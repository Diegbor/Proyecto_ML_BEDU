---
title: "Proyecto Consumo de Agua"
author: "Equipo 24 BEDU"
format: 
  html: 
    theme: journal
    toc: true 
    code-fold: false
    code-tools: true 
editor: visual
---

# Consumo de Agua en Ciudad de México.

## Objetivo

El consumo general de agua en México es uno de las preocupaciones más grandes de los últimos años debido a la creciente escasez en toda la República. Con los años, se han registrado cientos de casos donde las demandas de agua potable a viviendas han excedido debido al incremento de viviendas, población y la falta de mantenimiento en el servicio de tuberías, lo que ha causado fugas de agua constantemente.

Nuestro trabajo pretende analizar datos del consumo del agua en las alcaldías de la Ciudad de México obtenidos de SACMEX, del primer semestre de 2019. También analizar los registros de reportes de fugas de agua, mala calidad y falta de agua en la Ciudad de México, obtenidos de SACMEX a partir de 2020.

El objetivo del proyecto es poder evaluar y predecir la cantidad de fugas de agua en la Ciudad de México, haciendo una comparación con el incremento de consumo de agua, el crecimiento poblacional y expansión de áreas urbanas en Ciudad de México.

## Descripción de nuestra Base de Datos.

1.  **Datos obtenidos de SACMEX: información del primer bimestre de 2019 por concepto de suministro de agua a nivel manzana considerando la facturación por servicio de consumo medido y promedio.**

2.  Crecimiento poblacional por alcandía en la Ciudad de México.

3.  Incremento de viviendas, tipos de viviendas, oficinas, tipo de oficinas, otro tipo de infraestructura.

4.  **Reportes de fugas. https://datos.cdmx.gob.mx/dataset/reportes-de-agua/**

5.  El uso del agua por alcaldía: doméstico, industrial, etc.

### Lectura de Datos:

```{r}

# Librerías 
library(ggplot2) # gráficas
library(dplyr)   # dataframes 
library(tidyverse) 
library(tidyr)
```

1.  Consumo de agua Histórico 2019

```{r}

# Datos de la base de datos de consumo de agua del primer bimestre de 2019 en Ciudad de México.
# df.consumo <- read.csv('E:/BEDU/Curso 5/Proyecto/Datos/consumo_agua_historico_2019.csv')
```

2.  Reportes de fugas. https://datos.cdmx.gob.mx/dataset/reportes-de-agua

```{r}
# Datos de la base de datos de reporte de fugas en Ciudad de México de 2018 a 2022.
df.fugas <- read.csv('E:/BEDU/Curso 5/Proyecto/Datos/reportes_agua_hist.csv')

```

## Preprocesamiento de Datos

### Registro Histórico de Rpportes de Fugas 2018 - 2022

**Descripción inicial de los atributos de los datos**

Este conjunto de datos muestra información diaria referente a reportes realizados por ciudadanos usuarios del servicio de agua potable de al CDMX.

Datos obtenidos de: https://datos.cdmx.gob.mx/dataset/reportes-de-agua 

```{r}

# Primeras filas. 
head(df.fugas)

# Nombre de las columnas 
names(df.fugas)

# Acomodamos las filas 
df.fugas <- df.fugas[, c(7, 1, 2, 3, 4, 5, 6, 8, 9, 10)]

names(df.fugas)

head(df.fugas)

```

```{r}
# Clase de dataframe 
class(df.fugas)

```

```{r}
# Dimensión del dataframe 
dim(df.fugas)

```

```{r}
# Estructura de los dataframe 
(str(df.fugas))
```

```{r}
summary(df.fugas)
```

Podemos notar que existen 10 columnas con la siguiente información:

1.  fecha\
2.  folio\
3.  tipo_de_falla
4.  quien_atiende
5.  latitud
6.  longitud
7.  codigo_postal
8.  colonia_registro_sacmex
9.  colonia_datos_abiertos
10. alcaldia

```{r}
# Cambio de clase en la columna fecha
df.fugas <- df.fugas %>%
  mutate(fecha = as.Date(fecha))


# Cambio de clase en la columna codigo_postal
df.fugas <- df.fugas %>%
  mutate(codigo_postal = as.character(codigo_postal))
  summary(df.fugas)


```


**Análisis de Datos Nulos**

```{r}

data.frame('NA' = apply(X = is.na(df.fugas), MARGIN = 2, FUN = sum))

```

```{r}
# Eliminando datos nulos de alcaldía 

df.fugas.alcaldia <- complete.cases(df.fugas$alcaldia)

df.fugas.clean <- df.fugas[df.fugas.alcaldia,]

data.frame('NA' = apply(X = is.na(df.fugas.clean), MARGIN = 2, FUN = sum))


# Eliminando datos nulos de tipo de falla 

df.fugas.tf <- complete.cases(df.fugas.clean$tipo_de_falla)

df.fugas.clean <- df.fugas.clean[df.fugas.tf,]

data.frame('NA' = apply(X = is.na(df.fugas.clean), MARGIN = 2, FUN = sum))
```

## Análisis Exploratorio

```{r}
summary(df.fugas.clean)
```

```{r}
# Cambiar tipo de dato character a factor 

df.fugas.clean$tipo_de_falla  <- as.factor(df.fugas.clean$tipo_de_falla)

df.fugas.clean$quien_atiende  <- as.factor(df.fugas.clean$quien_atiende)

df.fugas.clean$alcaldia  <- as.factor(df.fugas.clean$alcaldia)

tb_tipo_falla <- data.frame(df.fugas.clean$tipo_de_falla)
tb_alcaldia <- data.frame(df.fugas.clean$alcaldia)
tb_quien_atiende <- data.frame(df.fugas.clean$quien_atiende)


```

### Análisis de la distribución de los datos.

**Análisis de las categorías de los datos.**

Tablas de Frecuencias y Gráficos de Barras para las columnas Tipos de Falla y Alcaldía

```{r}

# Tabla de Frecuencias Absolutas, Relativas
  
freq_tf <- df.fugas.clean %>%
           group_by(alcaldia, tipo_de_falla) %>%
           summarise(n = n()) %>%
           mutate(prop =  paste(round(100*prop.table(n), 2), "%", sep="")) 

# Gráfico de Frecuencias absolutas

graf_id <- df.fugas.clean %>%
          ggplot(aes(x = alcaldia, fill = tipo_de_falla)) +
           geom_bar() +
           #facet_wrap(~tipo_de_falla)+
            labs(title = "Reportes por Tipo de Falla", 
                 subtitle = "Por alcaldía. 2018-2022",
                 x = "Alcaldia",
                 y = "Frecuencia") +
           theme_minimal() +
           theme(axis.text.x  = element_text(angle = 90))
graf_id

```


### Distribuciones

Mostrando los datos convertidos a un dataframe por día, donde se incluye una columna que es el conteo de las fallas de agua por alcaldía. 

```{r}

# Tabla por alcaldía y por día

BENITO <- df.fugas.clean %>% 
               select(fecha, alcaldia, folio, tipo_de_falla) %>%
               filter(alcaldia == 'BENITO JUAREZ') %>%
               group_by(fecha) %>%
               summarise(count = n(), .groups = 'drop')

# Histogramas 


aa1 <- BENITO  %>%
    ggplot(aes(count)) +
    geom_histogram(bins = 5) +
    #facet_wrap(~indice_des) +
    labs(title = "Histograma", 
        x = "Reportes de Fallas",
        y = "Frequency") + 
    theme_minimal()

aa1


# Boxplot

aa2 <- BENITO  %>%
    ggplot(aes(y=count)) +
    geom_boxplot(varwidth = TRUE, alpha=0.2) +
    labs(title = "Boxplot", 
        x = "Reportes de Fallas",
        y = "Frequency")+ 
    theme_minimal()

aa2


aa3 <- BENITO %>%
      ggplot(aes(x = count)) +
      geom_density() + 
      guides(fill = guide_legend(title = "Reportes de Fallas"))+
      labs(title = "Densidad", 
        x = "Reportes de Fallas",
        y = "Frequency")+ 
      theme_classic()

aa3


# Gráfica de Dispersión 

aa4 <- BENITO %>%
      ggplot(aes(x = fecha, y= count)) +
      geom_line() + 
      guides(fill = guide_legend(title = "Reportes de Fallas"))+
      labs(title = "Densidad", 
        x = "Tiempo: días",
        y = "Reportes de Fallas")+ 
      theme_classic()

aa4


# Para usar plot_grid se necesita la libreria cowplot
library(cowplot)

completo <- plot_grid( aa1, aa2, aa3, aa4)



```


**Medidas de Tendencia Central y Dispersión**

Columnas numéricas: count


```{r}

BENITO <- df.fugas.clean %>% 
               select(fecha, alcaldia, folio, tipo_de_falla) %>%
               filter(alcaldia == 'BENITO JUAREZ') %>%
               group_by(fecha) %>%
               summarise(count = n(), .groups = 'drop')

nom.col <- colnames(BENITO)

library(moments)

  calcular_medidas <- function(dataframe, columna) {
    
    # Calcular las medidas descriptivas
    
    Max <- max(dataframe[[columna]], na.rm = TRUE)
    Min <- min(dataframe[[columna]], na.rm = TRUE)
    
    # Tendencia Central
    Media <- mean(dataframe[[columna]], na.rm = TRUE)
    Mediana <- median(dataframe[[columna]], na.rm = TRUE)
    
    # Medidas de Dispersión 
    Varianza <- var(dataframe[[columna]], na.rm = TRUE)
    Desv <- sd(dataframe[[columna]], na.rm = TRUE)
    
    RangoIQ <- IQR(dataframe[[columna]], na.rm = TRUE)
    cuartiles <- quantile(dataframe[[columna]], probs = c(0.25, 0.50, 0.75), na.rm = TRUE)
    deciles <- quantile(dataframe[[columna]], probs = c(0.2, 0.9), na.rm = TRUE)
    
    skw <- skewness(dataframe[[columna]], na.rm = TRUE)
    kts <- kurtosis(dataframe[[columna]], na.rm = TRUE)
    
    
    q.1 <- cuartiles[1]
    q.2 <- cuartiles[2]  
    q.3 <- cuartiles[3]
    d.2 <- deciles[1]
    d.9 <- deciles [2]
  
    # Crear un vector con las medidas
    medidas_vector <- c(Max, Min, Media, Mediana, Varianza, Desv, RangoIQ, 
                        q.1, q.2, q.3, d.2, d.9, skw, kts)
  
    return(medidas_vector)
  }


df.medidas <- data.frame(Medidas = calcular_medidas(BENITO, 2), 
                             row.names = c('Máximo', 'Mínimo',
                                           'Media', 'Mediana', 'Varianza', 
                                           'Desviación Estándar', 'Rango IQ',
                                           '1q', '2q', '3q', '2d', '9d',
                                           "Skewness", 'Curtosis'))


df.medidas

```

```{r}

# Outliers 

BENITO_OUT <- df.fugas.clean %>%
              filter(alcaldia == 'BENITO JUAREZ') %>%
              group_by(fecha, tipo_de_falla, quien_atiende, colonia_datos_abiertos) %>%
              summarise(count = n(), .groups = 'drop') %>%
              filter(count > 50)
  
BENITO_OUT
```


### Principales inferencias de la información

Interpretación y Conclusiones


```{r}
graf_id

```
```{r}
completo
```


## Metodología del Modelo

Descripción de la metodología del Modelo

### Modelo - Jorge

Descomposición de la serie de tiempo.

ARIMA(p,d,q)

Criterios de Evaluación: AIC, DF, etc.

### Resultados Shiny - Jorge

Presentación del mejor modelo ARIMA.

Gráficos importantes.

## Conclusiones

Interpretación de los resultados del modelo

## Referencias

-   Limache Sandoval, E. M. (2021). Modelo ARIMA sobre el consumo de agua de uso poblacional en la ciudad de Tacna. *REVISTA VERITAS ET SCIENTIA - UPT*, *10*(1), 69–82. https://doi.org/10.47796/ves.v10i1.461

-   Datos Abiertos: Consumo de agua. SACMEX <https://datos.cdmx.gob.mx/sv/dataset/consumo-agua>
